# RAG 系统架构文档 (RAG System Architecture)

## 系统概述

MyEnglishNote RAG (Retrieval-Augmented Generation) 系统是一个基于向量检索的智能英语学习助手，通过向量相似度搜索找到相关笔记，并结合大语言模型生成个性化的学习建议。

---

## 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                          客户端层                                 │
│                     (Web / Mobile App)                           │
└────────────────────────┬────────────────────────────────────────┘
                         │ HTTP/HTTPS
                         │
┌────────────────────────▼────────────────────────────────────────┐
│                      控制器层 (Controller)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ RAGController│  │ NoteController│  │ UserController│         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└────────────────────────┬────────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────────┐
│                      服务层 (Service)                             │
│  ┌──────────────────┐  ┌─────────────────┐  ┌───────────────┐  │
│  │   RAGService     │  │ EmbeddingService│  │ DeepseekService│  │
│  │  (核心业务逻辑)   │  │  (向量处理)      │  │  (AI API)      │  │
│  └──────────────────┘  └─────────────────┘  └───────────────┘  │
│           │                     │                     │          │
│           │                     │                     │          │
│  ┌────────▼─────────────────────▼─────────────────────▼───────┐ │
│  │                     工具层 (Util)                            │ │
│  │  ┌─────────────┐  ┌──────────────┐  ┌─────────────┐       │ │
│  │  │ VectorUtil  │  │EmbeddingUtil │  │  HttpUtil   │       │ │
│  │  │ (向量计算)   │  │ (格式转换)    │  │ (HTTP请求)  │       │ │
│  │  └─────────────┘  └──────────────┘  └─────────────┘       │ │
│  └───────────────────────────────────────────────────────────┘ │
└────────────────────────┬────────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────────┐
│                    数据访问层 (Mapper)                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  NoteMapper  │  │ ReviewMapper │  │EmbeddingMapper│         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└────────────────────────┬────────────────────────────────────────┘
                         │ JDBC
                         │
┌────────────────────────▼────────────────────────────────────────┐
│                       数据库层                                    │
│  ┌─────────────────┐         ┌──────────────────┐              │
│  │   MySQL 8.0     │   或    │ PostgreSQL 14+   │              │
│  │  (JSON向量)      │         │  (pgvector)      │              │
│  └─────────────────┘         └──────────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────────┐
│                      外部服务                                     │
│  ┌──────────────────────────────────────────────────┐          │
│  │        Deepseek API (OpenAI 兼容)                │          │
│  │  • Embedding API (text-embedding)                │          │
│  │  • Chat Completion API (chat/completions)        │          │
│  └──────────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 核心组件

### 1. RAGService (核心业务逻辑)

**职责：**
- 向量检索笔记
- 生成 AI 回答
- 协调各个服务

**核心方法：**

```java
// 向量检索相关笔记
List<EnglishNote> searchNotes(Long userId, String query, 
                               Double threshold, Integer maxResults);

// 生成 AI 回答
RAGResponse generateAnswer(Long userId, String question, 
                          Double threshold, Integer maxResults, 
                          Boolean includeContext);
```

**工作流程：**

```
1. 接收用户查询
   ↓
2. 调用 Deepseek API 生成查询向量
   ↓
3. 从数据库获取用户所有笔记
   ↓
4. 在应用层并行计算相似度
   ↓
5. 过滤、排序、限制结果
   ↓
6. (可选) 结合上下文生成 AI 回答
   ↓
7. 返回结果
```

### 2. VectorUtil (向量计算工具)

**职责：**
- 向量相似度计算
- 向量运算（点积、模长等）
- 批量并行计算
- 缓存管理

**支持的算法：**
- 余弦相似度 (Cosine Similarity)
- 欧氏距离 (Euclidean Distance)
- 曼哈顿距离 (Manhattan Distance)

**关键特性：**
- 并行流处理（利用多核 CPU）
- 可选的缓存机制（LRU）
- 性能监控

### 3. EmbeddingService (向量处理服务)

**职责：**
- 向量序列化/反序列化
- 向量验证和归一化
- 向量缓存管理

**核心方法：**

```java
// JSON ↔ List<Double> 转换
String embeddingToJson(List<Double> embedding);
List<Double> jsonToEmbedding(String json);

// 向量验证
boolean validateEmbedding(List<Double> embedding, int expectedDimension);

// 向量归一化
List<Double> normalizeEmbedding(List<Double> embedding);

// 缓存管理
void cacheEmbedding(String key, List<Double> embedding);
List<Double> getCachedEmbedding(String key);
```

---

## 相关文档

- [数据库选择指南](../DATABASE_GUIDE.md)
- [向量优化说明](../VECTOR_OPTIMIZATION.md)
- [迁移指南](MIGRATION.md)

---

## 总结

MyEnglishNote RAG 系统通过合理的架构设计和性能优化，实现了高效的向量检索和智能回答生成。系统具有良好的可扩展性和可维护性，为未来的功能扩展奠定了坚实的基础。
